#!/bin/sh

ARM=/dev/shm/on-setarm

incr_shot() {
        shot=0
        SHOT=/etc/acq400/0/${1:-shot}
        if [ -e ${SHOT} ]; then
                shot=$(cat ${SHOT})
        fi
        let shot=$shot+1
        echo $shot > ${SHOT}
}

source /usr/local/bin/init_stream

if [ -e $ARM ]; then
	inotifywait -e close_write $ARM 2>/dev/null >/dev/null
else
	while [ ! -e $ARM ]; do
		sleep 1
	done
fi

init_stream 0

source /dev/shm/transient_settings

ARGS="--state-file /dev/shm/state $*"

if [ "x$OSAM" != "x" ] && [ $OSAM -gt 0 ]; then
# negative code means "one sample per buffer". This is what we want
	ARGS="$ARGS -O -$OSAM"	
fi

STREAM=acq400_stream
if [ -e /mnt/local/acq400_stream ]; then
	STREAM=/mnt/local/acq400_stream
fi
CMD="$STREAM --verbose=0 --soft-trigger=$SOFT_TRIGGER \
	--demux 1 --pre=$PRE --post=$POST $ARGS 0"
	
echo run $CMD
$CMD

if [ -e /mnt/local/postshot ]; then
        /mnt/local/postshot
fi

incr_shot shot_complete

exec /usr/local/bin/faultmon

